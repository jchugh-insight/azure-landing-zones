{
    "$schema": "<relative path to createFormUI.schema.json>",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "Azure Foundations - Spoke Landing Zone",
            "steps": [
                {
                    "name": "basics",
                    "label": "Spoke Landing Zone",
                    "elements": [
                        {
                            "name": "deploymentDetails",
                            "label": "Deployment Details",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "deploymentDetailsText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "Select the subscription and location to specify the scope of the Landing Zone deployment.",
                                        "link": {
                                            "label": "",
                                            "uri": ""
                                        }
                                    }
                                },
                                {
                                    "name": "subscriptionApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "subscriptions?api-version=2020-01-01"
                                    }
                                },
                                {
                                    "name": "subscriptionId",
                                    "label": "Subscription",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Select the Subscription of your Data Landing Zone.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').deploymentDetails.subscriptionApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.id, '\",\"description\":\"', 'ID: ', item.subscriptionId, '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "landingZonePrefix",
                                    "label": "Landing Zone Prefix",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Specify a prefix (min 1 and max 5 lowercase characters and numbers).",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9]{1,5}$",
                                        "validationMessage": "The prefix must be between 1-5 lowercase characters and numbers."
                                    }
                                },
                                {
                                    "name": "locationsApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "locations?api-version=2019-11-01"
                                    }
                                },
                                {
                                    "name": "locationName",
                                    "label": "Location",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Select the Location for the Deployment.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('basics').deploymentDetails.locationsApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.name, '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "environment",
                                    "label": "Environment",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "Development",
                                    "toolTip": "Select the environment for the Landing Zone.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Development",
                                                "description": "Select if you want to deploy a development environment.",
                                                "value": "dev"
                                            },
                                            {
                                                "label": "Test",
                                                "description": "Select if you want to deploy a test environment.",
                                                "value": "tst"
                                            },
                                            {
                                                "label": "Production",
                                                "description": "Select if you want to deploy a production environment.",
                                                "value": "prd"
                                            }
                                        ],
                                        "required": true
                                    }
                                }
                            ]
                        },
                        {
                            "name": "azureNamingIdentifiers",
                            "label": "Azure Naming Identifiers",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "namingIdentifierText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "Provide naming identifiers for Azure resources.",
                                        "link": {
                                            "label": "",
                                            "uri": ""
                                        }
                                    }
                                },
                                {
                                    "name": "argIdentifier",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Resource Group Identifier",
                                    "toolTip": "Provide a value for the Resource Group identifier",
                                    "defaultValue": "arg",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{3}$",
                                        "validationMessage": "The prefix must be 3 characters."
                                    }
                                },
                                {
                                    "name": "vntIdentifier",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Virtual Network Identifier",
                                    "toolTip": "Provide a value for the Virtual Network identifier",
                                    "defaultValue": "vnt",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{3}$",
                                        "validationMessage": "The prefix must be 3 characters."
                                    }
                                },
                                {
                                    "name": "staIdentifier",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Storage Identifier",
                                    "toolTip": "Provide a value for the Storage identifier",
                                    "defaultValue": "sta",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{3}$",
                                        "validationMessage": "The prefix must be 3 characters."
                                    }
                                },
                                {
                                    "name": "udrIdentifier",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Route Table Identifier",
                                    "toolTip": "Provide a value for the Route Table identifier",
                                    "defaultValue": "udr",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{3}$",
                                        "validationMessage": "The prefix must be 3 characters."
                                    }
                                },
                                {
                                    "name": "nsgIdentifier",
                                    "type": "Microsoft.Common.TextBox",
                                    "label": "Network Security Group Identifier",
                                    "toolTip": "Provide a value for the Network Security Group identifier",
                                    "defaultValue": "nsg",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^[a-z0-9A-Z-]{3}$",
                                        "validationMessage": "The prefix must be 3 characters."
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "lzConnectivity",
                    "label": "Network Topology & Connectivity",
                    "subLabel": {
                        "preValidation": "Provide all network settings for the Landing Zone.",
                        "postValidation": "Done"
                    },
                    "bladeTitle": "Network Topology & Connectivity",
                    "bladeSubtitle": "Network Topology & Connectivity",
                    "elements": [
                        {
                            "name": "virtualNetworkConfiguration",
                            "label": "Landing Zone Virtual Network Configuration",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "virtualNetworkConfigurationText",
                                    "type": "Microsoft.Common.TextBlock",
                                    "visible": true,
                                    "options": {
                                        "text": "Specify the Virtual network and subnet CIDR range for the Landing Zone.",
                                        "link": {
                                            "label": "",
                                            "uri": ""
                                        }
                                    }
                                },
                                {
                                    "name": "spoke",
                                    "type": "Microsoft.Common.OptionsGroup",
                                    "label": "Deploy the Landing Zone Virtual Network",
                                    "defaultValue": "Yes",
                                    "toolTip": "If 'Yes' is selected, a Virtual Network will be deployed.",
                                    "constraints": {
                                        "allowedValues": [
                                            {
                                                "label": "Yes",
                                                "value": "Yes"
                                            },
                                            {
                                                "label": "No",
                                                "value": "No"
                                            }
                                        ]
                                    },
                                    "visible": true
                                },
                                {
                                    "name": "virtualNetworkAddressCidrRange",
                                    "label": "Vnet Address CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[equals(steps('lzConnectivity').spoke, 'Yes')]",
                                    "defaultValue": "10.1.0.0/16",
                                    "toolTip": "Specify a Virtual Network address CIDR range.",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:$|/(1[0-9]|2[0-4]))$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [10,24]."
                                    }
                                },
                                {
                                    "name": "webSubnetAddressPrefix",
                                    "label": "Web Subnet CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "10.1.0.0/24",
                                    "toolTip": "Specify a CIDR range for the subnet",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:$|/(2[4-8]))$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [24,28]."
                                    }
                                },
                                {
                                    "name": "appsSubnetAddressPrefix",
                                    "label": "App Subnet CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "10.1.1.0/24",
                                    "toolTip": "Specify a CIDR range for the subnet",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:$|/(2[4-8]))$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [24,28]."
                                    }
                                },
                                {
                                    "name": "dataSubnetAddressPrefix",
                                    "label": "Data Subnet CIDR Range",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": true,
                                    "defaultValue": "10.1.2.0/24",
                                    "toolTip": "Specify a CIDR range for the subnet",
                                    "constraints": {
                                        "required": true,
                                        "regex": "^(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(?:$|/(2[4-8]))$",
                                        "validationMessage": "Invalid CIDR range. The address prefix must be in the range [24,28]."
                                    }
                                }
                            ]
                        },
                        {
                            "name": "platformConnectivityVnetConfiguration",
                            "label": "Platform Connectivity Hub Details",
                            "type": "Microsoft.Common.Section",
                            "visible": true,
                            "elements": [
                                {
                                    "name": "infoBoxDataManagementZoneVnet",
                                    "type": "Microsoft.Common.InfoBox",
                                    "visible": true,
                                    "options": {
                                        "text": "Please select the Virtual Network in the Platform Connectivity Hub to peer it with the Landing Zone.",
                                        "style": "Info"
                                    }
                                },
                                {
                                    "name": "subscriptionApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "subscriptions?api-version=2020-01-01"
                                    }
                                },
                                {
                                    "name": "connectivitySub",
                                    "label": "Platform Connectivity Subscription",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Select the Subscription for the hub connectivity.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('connectivitySettings').platformConnectivityVnetConfiguration.subscriptionApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.id, '\",\"description\":\"', 'ID: ', item.subscriptionId, '\"}')))]",
                                        "required": true
                                    }
                                },
                                {
                                    "name": "virtualNetworkApi",
                                    "type": "Microsoft.Solutions.ArmApiControl",
                                    "request": {
                                        "method": "GET",
                                        "path": "[concat(steps('connectivitySettings').platformConnectivityVnetConfiguration.connectivitySub, '/providers/Microsoft.Network/virtualNetworks?api-version=2020-11-01')]"
                                    }
                                },
                                {
                                    "name": "connectivityResourceGroup",
                                    "type": "Microsoft.Common.TextBox",
                                    "visible": "[equals(steps('lzConnectivity').spoke, 'Yes')]",
                                    "label": "Platform Connectivity Virtual Network Resource Group ",
                                    "toolTip": "Provide the Resource Group of the platform connectivity virtual network",
                                    "defaultValue": "stt-syd-conn-arg-network",
                                    "constraints": {
                                        "required": true
                                    }
                                },
                                {
                                    "name": "connectivityVirtualNetwork",
                                    "label": "Platform Connectivity Virtual Network",
                                    "type": "Microsoft.Common.DropDown",
                                    "visible": true,
                                    "defaultValue": "",
                                    "toolTip": "Select the Platform Connectivity Virtual Network.",
                                    "multiselect": false,
                                    "selectAll": false,
                                    "filter": true,
                                    "filterPlaceholder": "Filter items ...",
                                    "multiLine": true,
                                    "constraints": {
                                        "allowedValues": "[map(steps('connectivitySettings').platformConnectivityVnetConfiguration.virtualNetworkApi.value, (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.id, '\",\"description\":\"', 'Subscription ID: ', last(take(split(item.id, '/'), 3)), '\"}')))]",
                                        "required": true
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    "name": "tags",
                    "label": "Tags",
                    "subLabel": {
                        "preValidation": "Provide tags that will be used for all resources.",
                        "postValidation": "Done"
                    },
                    "bladeTitle": "Tags",
                    "bladeSubtitle": "Tags",
                    "elements": [
                        {
                            "name": "tagsByResource",
                            "label": "Tags by Resource",
                            "type": "Microsoft.Common.TagsByResource",
                            "visible": true,
                            "resources": [
                                "EnterpriseScaleAnalytics"
                            ]
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "kind": "Subscription",
            "location": "[steps('basics').deploymentDetails.locationName]",
            "subscriptionId": "[steps('basics').deploymentDetails.subscriptionId]",
            "parameters": {
                "location": "[if(empty(steps('basics').deploymentDetails.locationName), '', steps('basics').deploymentDetails.locationName)]",
                "environment": "[if(empty(steps('basics').deploymentDetails.environment), '', steps('basics').deploymentDetails.environment)]",
                "lzPrefix": "[if(empty(steps('basics').deploymentDetails.landingZonePrefix), '', steps('basics').deploymentDetails.landingZonePrefix)]",
                "argPrefix": "[steps('basics').azureNamingIdentifiers.argIdentifier]",
                "vntPrefix": "[steps('basics').esVntIdentifier.vntIdentifier]",
                "staPrefix": "[steps('basics').esStaIdentifier.staIdentifier]",
                "udrPrefix": "[steps('basics').esUdrIdentifier.udrIdentifier]",
                "nsgPrefix": "[steps('basics').esNsgIdentifier.nsgIdentifier]",

                "vnetAddressPrefix": "[if(empty(steps('lzConnectivity').virtualNetworkConfiguration.virtualNetworkAddressCidrRange), '', steps('lzConnectivity').virtualNetworkConfiguration.virtualNetworkAddressCidrRange)]",
                "webSubnetAddressPrefix": "[if(empty(steps('lzConnectivity').virtualNetworkConfiguration.webSubnetAddressPrefix), '', steps('lzConnectivity').virtualNetworkConfiguration.webSubnetAddressPrefix)]",
                "appsSubnetAddressPrefix": "[if(empty(steps('lzConnectivity').virtualNetworkConfiguration.appsSubnetAddressPrefix), '', steps('lzConnectivity').virtualNetworkConfiguration.appsSubnetAddressPrefix)]",
                "dataSubnetAddressPrefix": "[if(empty(steps('lzConnectivity').virtualNetworkConfiguration.dataSubnetAddressPrefix), '', steps('lzConnectivity').virtualNetworkConfiguration.dataSubnetAddressPrefix)]",
                
                "portalDeployment": true,
                "tags": "[if(empty(steps('tags').tagsByResource.EnterpriseScaleAnalytics), parse('{}'), steps('tags').tagsByResource.EnterpriseScaleAnalytics)]"
            }
        }
    }
}